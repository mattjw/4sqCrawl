<!DOCTYPE html><html lang="en">  <head>	    <meta charset="utf-8">    <title>Fourcrawl</title>    <meta name="description" content="Fourcrawl - the foursquare pub crawl manager">    <meta name="author" content="">    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->    <!--[if lt IE 9]>      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>    <![endif]-->    <!-- Le styles -->    <link href="css/bootstrap.min.css" rel="stylesheet">    <link href="css/fourcrawl.css" rel="stylesheet">    <script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>    <script type="text/javascript" src="js/jquery.ba-bbq.min.js"></script>    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>         	    <style type="text/css">      body {        padding-top: 60px;      }    </style>		    <!-- Le fav and touch icons -->    <link rel="shortcut icon" href="images/favicon.ico">    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png"><script type="text/javascript">  var token;  var directionDisplay;  var directionsService = new google.maps.DirectionsService();  $(document).ready(function(){    var client_id       = 'RT1TB51QQTKDMYM0UYTJVLPFVMP0YUVNSQS3MCGUIPV50GY0';    var callback_url    = 'http://localhost/~martin/find_first_venue.html';    var selectedvenues = [];    var selectedMarkers = [];    var initialLocation;    var cardiff = new google.maps.LatLng(51.481307,-3.18049860);    var browserSupportFlag =  new Boolean();    var infowindow = new google.maps.InfoWindow;    var map;    var baricon_off = new google.maps.MarkerImage( "http://localhost/~martin/images/bar_off.png", new google.maps.Size(32, 40), new google.maps.Point(0, 0), new google.maps.Point(16, 40) );     var baricon_on = new google.maps.MarkerImage( "http://localhost/~martin/images/bar_on.png", new google.maps.Size(32, 40), new google.maps.Point(0, 0), new google.maps.Point(16, 40) );     if ($.bbq.getState('access_token'))     {      var directionsMarkerOptions = {        visible: false      }      var directionsRendererOptions = {        markerOptions: directionsMarkerOptions,        preserveViewport: true,        suppressMarkers: true      }      directionsDisplay = new google.maps.DirectionsRenderer(directionsRendererOptions);      token = $.bbq.getState('access_token');      $.bbq.pushState({}, 2);      var myOptions = {        zoom: 14,        mapTypeId: google.maps.MapTypeId.ROADMAP      };      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);      directionsDisplay.setMap(map);      // Try W3C Geolocation (Preferred)      if(navigator.geolocation)       {        browserSupportFlag = true;        navigator.geolocation.getCurrentPosition(function(position) {          initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);          map.setCenter(initialLocation);          getNearbyVenues(initialLocation);        }, function() {          handleNoGeolocation(browserSupportFlag);          getNearbyVenues(initialLocation);      });      // Try Google Gears Geolocation      } else if (google.gears) {        browserSupportFlag = true;        var geo = google.gears.factory.create('beta.geolocation');        geo.getCurrentPosition(function(position) {          initialLocation = new google.maps.LatLng(position.latitude,position.longitude);          map.setCenter(initialLocation);          getNearbyVenues(initialLocation);        }, function() {          handleNoGeoLocation(browserSupportFlag);          getNearbyVenues(initialLocation);      });      // Browser doesn't support Geolocation      } else {        browserSupportFlag = false;        handleNoGeolocation(browserSupportFlag);        getNearbyVenues(initialLocation);      }      function handleNoGeolocation(errorFlag) {        if (errorFlag == true) {          alert("Geolocation service failed.");          initialLocation = cardiff;        } else {          alert("Your browser doesn't support geolocation. We've placed you in Cardiff.");          initialLocation = cardiff;        }        map.setCenter(initialLocation);      }          }     else if ($.bbq.getState('error'))     {      alert('some sort of error');    }     else     {        /* Redirect for foursquare authentication. */        window.location.href = 'https://foursquare.com/oauth2/authenticate?client_id=' + client_id + '&response_type=token&redirect_uri=' + callback_url;    }     var markersArray = [];    function getNearbyVenues(location) {      /* Query foursquare API for venue recommendations near the current location. */      $.getJSON('https://api.foursquare.com/v2/venues/search?ll=' + location.lat() + "," + location.lng() + '&categoryId=4d4b7105d754a06376d81259&limit=50&oauth_token=' + token, {}, function(data) {        venues = data['response']['groups'][0]['items'];        /* Place marker for each venue. */        selectedVenueIDs = [];        for (i in selectedvenues) {          selectedVenueIDs.push(selectedvenues[i]['id']);        }        for (var i = 0; i < venues.length; i++) {          if( $.inArray(venues[i]['id'], selectedVenueIDs) == -1) {            var marker = new google.maps.Marker({              animation: google.maps.Animation.DROP,              position: new google.maps.LatLng(venues[i]['location']['lat'], venues[i]['location']['lng']),              map: map,              icon: baricon_off,              title: venues[i]['name']            });            markersArray.push(marker);            addInfoWindow(marker, venues[i]);          }        }         });    }             function addInfoWindow(marker, venue) {      google.maps.event.addListener(marker, 'click', function(event){        infowindow.close()        infowindow = new google.maps.InfoWindow({        maxHeight: 400,        content:  "<div style='background-image:url(images/bar.png);background-repeat:no-repeat;padding:0 10px 10px 42px;'><h3>"  + venue['name'] + "</h3><span>" + venue['location']['address'] + "</span></div><button id='" + venue['id'] + "'style='display:block' class='btn success addvenue'>Add place</button>"        });                     infowindow.open(marker.get('map'), marker);        $('.addvenue').click(function (){          selectVenue($(this).attr('id'), marker);          infowindow.close();        });      });           }    function selectVenue(id, marker) {    var currentVenue;      for(i in venues) {        if(venues[i]['id'] == id) {          selectedvenues.push(venues[i]);          selectedMarkers.push(marker)          marker.setIcon(baricon_on)          currentVenue = venues[i];        }      }      deleteOverlays();      newLocation = new google.maps.LatLng(currentVenue['location']['lat'],currentVenue['location']['lng']);      map.setCenter(newLocation);      getNearbyVenues(newLocation);      updateVenuesList();      getDirections();    }    function updateVenuesList() {      venuehtml = '';       for(i in selectedvenues) {        venuehtml += '<p>' + selectedvenues[i]['name'] + '</p>';      }      $("#selectedVenuesList").html(venuehtml);    }    function deleteOverlays() {      if (markersArray) {        for (i in markersArray) {          markersArray[i].setMap(null);         }        markersArray.length = 0;        for (i in selectedMarkers) {          selectedMarkers[i].setMap(map)        }      }    }    function getDirections() {      var waypoints = [];      if(selectedMarkers.length >= 2) {        for(i in selectedMarkers) {          waypoints.push({location: selectedMarkers[i].getPosition(), stopover : true});        }        var request = {          origin: selectedMarkers[0].getPosition(),          destination: selectedMarkers[selectedMarkers.length-1].getPosition(),          waypoints: waypoints,          travelMode: mode = google.maps.DirectionsTravelMode.WALKING,          optimizeWaypoints: false,          avoidHighways: false,          avoidTolls: false        };           directionsService.route(request, function(response, status) {          if (status == google.maps.DirectionsStatus.OK) {            directionsDisplay.setDirections(response);          }          else {            alert('' + status + ' ' + waypoints.length);          }        });      }    }       });</script>  </head>  <body>    <div class="topbar">      <div class="fill">        <div class="container">          <a class="brand" href="#">four<span class="italics">crawl</span></a>          <ul class="nav">            <!-- <li class="active"><a href="#">Home</a></li> -->            <li><a href="#about">About</a></li>            <li><a href="#contact">Contact</a></li>          </ul>        </div>      </div>    </div>	<div id="map_canvas" style="width: 100%; height: 400px;"></div>    <div class="container">    </div> <!-- /container -->    <p> Venues so far: </p>    <div class="container" id="selectedVenuesList">    </div> <!-- /selectedVenuesList -->    <div id="directionsPanel">    </div> 			  </body></html>